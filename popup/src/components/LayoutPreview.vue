<template>
  <div ref="el" :style="mergedStyle"></div>
</template>

<script setup lang="ts">
import type { StyleValue } from 'vue'
import { computed, ref } from 'vue'
import { useDraggable } from '@vueuse/core'

const props = defineProps<{
  isDraggable: boolean
  imageUrl: string
  opacity: number
  userStyle: StyleValue
}>()

const defaultStyle = computed<StyleValue>(() => {
  return {
    backgroundSize: '100% auto',
    backgroundImage: `url(${props.imageUrl})`,
    zIndex: 990,
    backgroundRepeat: 'no-repeat',
    backgroundPosition: 'center',
    touchAction: 'none'
  }
})

const el = ref<HTMLElement | null>(null)
const { style: dragStyle } = useDraggable(el)

const controlStyle = computed<StyleValue[]>(() => {
  const pointerEventsStyle = props.isDraggable ? '' : 'pointer-events: none;'
  const commonControlStyle = [pointerEventsStyle, { opacity: `${props.opacity}%` }]

  // init value, do not change style
  if (dragStyle.value === 'left:0px;top:0px;') {
    return [...commonControlStyle]
  }

  return [
    dragStyle.value,
    {
      position: 'fixed',
      margin: 'unset'
    },
    ...commonControlStyle
  ]
})

const mergedStyle = computed<StyleValue>(() => {
  return [defaultStyle.value, props.userStyle, ...controlStyle.value]
})
</script>
